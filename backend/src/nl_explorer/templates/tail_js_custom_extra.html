{#
  NL Explorer â€” floating "Ask Data" button injected into every Superset page.
  Opens the NL Explorer SPA in a slide-in drawer via an <iframe>.
  This file overrides Superset's intentionally empty tail_js_custom_extra.html.
#}
<style>
  #nl-explorer-fab {
    position: fixed;
    bottom: 28px;
    right: 28px;
    z-index: 9999;
    width: 52px;
    height: 52px;
    border-radius: 50%;
    background: #1890ff;
    color: #fff;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    transition: background 0.2s, transform 0.2s;
  }
  #nl-explorer-fab:hover { background: #096dd9; transform: scale(1.08); }

  #nl-explorer-drawer {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 480px;
    height: 100vh;
    z-index: 9998;
    background: #fff;
    box-shadow: -4px 0 24px rgba(0,0,0,0.18);
    transform: translateX(110%);
    transition: transform 0.3s cubic-bezier(.4,0,.2,1);
    display: flex;
    flex-direction: column;
  }
  #nl-explorer-drawer.open { transform: translateX(0); }

  #nl-explorer-drawer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    background: #fafafa;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-weight: 600;
    font-size: 15px;
    color: #1f1f1f;
  }
  #nl-explorer-close {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: #595959;
    padding: 0 4px;
    line-height: 1;
  }
  #nl-explorer-close:hover { color: #000; }

  #nl-explorer-iframe {
    flex: 1;
    border: none;
    width: 100%;
  }
</style>

<button id="nl-explorer-fab" title="Ask Data (AI)" aria-label="Open AI Data Explorer">
  &#x1F4AC;
</button>

<div id="nl-explorer-drawer" role="dialog" aria-label="AI Data Explorer" aria-hidden="true">
  <div id="nl-explorer-drawer-header">
    <span>Ask Data</span>
    <button id="nl-explorer-close" aria-label="Close">&times;</button>
  </div>
  <iframe id="nl-explorer-iframe" src="" title="AI Data Explorer"></iframe>
</div>

<script>
  (function () {
    var fab = document.getElementById('nl-explorer-fab');
    var drawer = document.getElementById('nl-explorer-drawer');
    var closeBtn = document.getElementById('nl-explorer-close');
    var iframe = document.getElementById('nl-explorer-iframe');
    var loaded = false;

    function buildContext() {
      var bd = window.bootstrapData || {};
      var path = window.location.pathname;

      // Explore page: form_data contains datasource info
      var datasource = null;
      if (bd.form_data) {
        datasource = (bd.form_data.datasource_name) ||
                     (bd.datasource && bd.datasource.name) || null;
      }

      // Dashboard page
      var dashboard = null;
      if (bd.dashboard_data) {
        dashboard = bd.dashboard_data.dashboard_title || null;
      }

      return {
        page: path,
        datasource: datasource,
        dashboard: dashboard,
        user: bd.user ? (bd.user.username || bd.user.email) : null,
        // Org-level config injected via COMMON_BOOTSTRAP_OVERRIDES_FUNC
        org: bd.nl_explorer || {},
      };
    }

    function sendContextToIframe() {
      try {
        iframe.contentWindow.postMessage({
          type: 'NL_EXPLORER_CONTEXT',
          payload: buildContext(),
        }, window.location.origin);
      } catch (e) { /* cross-origin guard */ }
    }

    function openDrawer() {
      if (!loaded) {
        iframe.src = '/nl-explorer/';
        loaded = true;
        iframe.addEventListener('load', sendContextToIframe);
      } else {
        // Re-send context in case the user navigated to a different page
        sendContextToIframe();
      }
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
      fab.style.display = 'none';
    }

    function closeDrawer() {
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
      fab.style.display = '';
    }

    fab.addEventListener('click', openDrawer);
    closeBtn.addEventListener('click', closeDrawer);

    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && drawer.classList.contains('open')) closeDrawer();
    });
  })();
</script>
